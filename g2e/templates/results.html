{% extends 'wrapper.html' %}
{% block body %}

    <script src="static/js/results.js"></script>

    <div class="results">
        <h1>Results</h1>
        <table>
            <caption class="top">Share</caption>
            <tbody>
                <tr>
                    <td>Permanent link to these results</td>
                    <td>{{ permanent_link }}</td>
                </tr>
            </tbody>
        </table>

        {% if gene_signature.tags|length > 0 %}
            <table>
                <caption>Tags</caption>
                <tr>
                    <td></td>
                    <td>
                        {% for tag in gene_signature.tags %}
                            <a href="{{ tags_url }}/{{ tag.name }}">{{ tag.name }}</a>{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </td>
                </tr>
            </table>
        {% endif %}

        <table>
            <caption>SOFT file</caption>
            <tr>
                <td>Description</td>
                {% if gene_signature.soft_file.is_geo %}
                    <td><a href="{{ geo_url }}" target="_blank">{{ gene_signature.soft_file.name }}</a></td>
                {% else %}
                    <td>{{ gene_signature.soft_file.name }}</td>
                {% endif %}
            </tr>
            <tr>
                <td>Platform</td>
                <td>{{ gene_signature.soft_file.platform }}</td>
            </tr>
            <tr>
                <td>Normalized</td>
                <td>{{ gene_signature.soft_file.normalize }}</td>
            </tr>
            <tr title="Parsed and cleaned SOFT file, with GEO metadata removed and only the control and samples listed.">
                <td>Parsed SOFT file</td>
                <td>
                    <a href="{{ gene_signature.soft_file.text_file }}" target="_blank">
                        <i class="fa fa-file-o"></i>
                    </a>
                </td>
            </tr>
        </table>

        {% if show_viz %}
            <table>
                <caption>Visualizations</caption>
                <tr>
                    <td>Principal Component Analysis</td>
                    <td>
                        <a href="{{ pca_url }}/{{ gene_signature.extraction_id }}">
                            <i class="fa fa-cube"></i>
                        </a>
                    </td>
                </tr>
                <tr>
                    <td>Hierarchical clustering</td>
                    <td>
                        <a href="{{ cluster_url }}/{{ gene_signature.extraction_id }}" target="_blank">
                            <i class="fa fa-map-o"></i>
                        </a>
                    </td>
                </tr>
            </table>
        {% endif %}
    
        <table>
            <caption>Metadata</caption>
            <tr>
                <td>Differential expression method</td>
                <td>{{ gene_signature.required_metadata.diff_exp_method }}</td>
            </tr>

            {% if gene_signature.required_metadata.diff_exp_method == 'chdir' %}
            <tr>
                <td>Cutoff</td>
                <td>{{ gene_signature.required_metadata.cutoff }}</td>
            </tr>
            {% endif %}

            {% if gene_signature.required_metadata.diff_exp_method == 'ttest' %}
            <tr>
                <td>Correction method</td>
                <td>{{ gene_signature.required_metadata.ttest_correction_method }}</td>
            </tr>
            {% endif %}

            {% for opt_meta in gene_signature.optional_metadata %}
                {% if opt_meta.name != 'user_key' %}
                    <tr>
                        <td class="capitalize-initial">{{ opt_meta.name|replace("_", " ") }}</td>
                        <td>
                            <a href="{{ metadata_url }}/{{ opt_meta.name }}/{{ opt_meta.value }}">{{ opt_meta.value }}</a>
                        </td>
                    </tr>
                {% endif %}
            {% endfor %}
        </table>

        <table class="gene-lists">
            <caption>External Links and Downloads</caption>
            <thead>
                <tr>
                    <td></td>
                    <td title="Text file containing a gene list resulting from differential expression analysis.">Gene lists</td>
                    <td title="Perform enrichment analysis against over 70 gene set libraries with Enrichr, a popular gene set enrichment analysis tool.">Enrichr</td>
                    {% if gene_signature.required_metadata.diff_exp_method == 'chdir' %}
                        <td title="Identify drugs that can potentially reverse expression using expression signatures from the LINCS L1000 small-molecule transcriptomics datasets processed with the Characteristic Direction method.">L1000CDS2</td>
                        <td title="Perform principle angle enrichment analysis against over 70 gene set libraries.">PAEA</td>
                    {% endif %}
                    {% if use_crowdsourcing %}
                        <td title="Crowdsourcin">Crowdsourcing</td>
                    {% endif %}
                </tr>
            </thead>
            {% for gene_list in gene_signature.gene_lists %}
                <tr>
                    <td>{{ gene_list.direction_as_string }}</td>
                    <td>
                        <a href="genelist/{{ gene_list.direction }}/{{ gene_signature.extraction_id }}" target="_blank">
                            <img src="static/image/download.png">
                        </a>
                    </td>
                    {% set num_apps = 2 if use_crowdsourcing else 1 %}
                    {% if gene_signature.required_metadata.diff_exp_method == 'chdir' %}
                        {% set num_apps = num_apps + 2 %}
                    {% endif %}
                    {% for i in range(num_apps) %}
                        {% set target_app_link = gene_list.target_app_links[i] %}
                        {% if target_app_link %}
                            <td>
                                <a href="{{ target_app_link.link }}" target="_blank">
                                    <img src="static/image/targetapp/{{ target_app_link.target_app.name }}.png">
                                </a>
                            </td>
                        {% else %}
                            <td></td>
                        {% endif %}
                    {% endfor %}
                </tr>
            {% endfor %}
        </table>
    </div>
{% endblock %}